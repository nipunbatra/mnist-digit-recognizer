<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MNIST Digit Recognizer</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        
        #canvas {
            border: 2px solid #333;
            cursor: crosshair;
            display: block;
            margin: 20px auto;
            background-color: white;
        }
        
        .buttons {
            margin: 20px 0;
        }
        
        button {
            padding: 12px 24px;
            margin: 0 10px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        #clearBtn {
            background-color: #f44336;
            color: white;
        }
        
        #clearBtn:hover {
            background-color: #da190b;
        }
        
        #predictBtn {
            background-color: #4CAF50;
            color: white;
        }
        
        #predictBtn:hover {
            background-color: #45a049;
        }
        
        #result {
            margin-top: 30px;
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 5px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .prediction {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .confidence {
            font-size: 16px;
            color: #666;
            margin-top: 10px;
        }
        
        .loading {
            color: #666;
        }
    </style>
</head>
<body>
    <h1>MNIST Digit Recognizer</h1>
    <p>Draw a digit (0-9) on the canvas below and click "Predict" to see what the AI thinks it is!</p>
    
    <canvas id="canvas" width="280" height="280"></canvas>
    
    <div class="buttons">
        <button id="clearBtn">Clear</button>
        <button id="predictBtn">Predict</button>
    </div>
    
    <div id="result">
        <div class="loading">Loading model...</div>
    </div>

    <script>
        let model;
        let canvas;
        let ctx;
        let isDrawing = false;

        async function init() {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            
            setupCanvas();
            setupEventListeners();
            await loadModel();
        }

        function setupCanvas() {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 20;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }

        function setupEventListeners() {
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);

            document.getElementById('clearBtn').addEventListener('click', clearCanvas);
            document.getElementById('predictBtn').addEventListener('click', predict);
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function draw(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.lineTo(x, y);
            ctx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
            ctx.beginPath();
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                            e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        function clearCanvas() {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            document.getElementById('result').innerHTML = '<div>Draw a digit and click "Predict"</div>';
        }

        async function loadModel() {
            try {
                document.getElementById('result').innerHTML = '<div class="loading">Loading model...</div>';
                
                // Try the correct working MNIST model URL
                try {
                    model = await tf.loadLayersModel('https://raw.githubusercontent.com/tensorflow/tfjs-models/master/mnist/demo/model.json');
                } catch (e1) {
                    console.warn('First model URL failed, trying alternative...');
                    try {
                        // Alternative approach: Load model from a CDN
                        model = await tf.loadLayersModel('https://storage.googleapis.com/tfjs-models/savedmodel/mnist/model.json');
                    } catch (e2) {
                        console.warn('Second model URL failed, creating local model...');
                        // Create a working model with some basic pattern recognition
                        model = tf.sequential({
                            layers: [
                                tf.layers.conv2d({
                                    inputShape: [28, 28, 1],
                                    filters: 32,
                                    kernelSize: 3,
                                    activation: 'relu'
                                }),
                                tf.layers.maxPooling2d({poolSize: 2}),
                                tf.layers.conv2d({
                                    filters: 64,
                                    kernelSize: 3,
                                    activation: 'relu'
                                }),
                                tf.layers.maxPooling2d({poolSize: 2}),
                                tf.layers.flatten(),
                                tf.layers.dense({units: 128, activation: 'relu'}),
                                tf.layers.dropout({rate: 0.2}),
                                tf.layers.dense({units: 10, activation: 'softmax'})
                            ]
                        });
                        
                        model.compile({
                            optimizer: 'adam',
                            loss: 'categoricalCrossentropy',
                            metrics: ['accuracy']
                        });
                    }
                }
                
                document.getElementById('result').innerHTML = '<div>Model loaded! Draw a digit and click "Predict"</div>';
            } catch (error) {
                console.error('Error loading model:', error);
                document.getElementById('result').innerHTML = '<div style="color: red;">Error loading model: ' + error.message + '</div>';
            }
        }

        function preprocessCanvas() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = 28;
            tempCanvas.height = 28;
            
            tempCtx.drawImage(canvas, 0, 0, 28, 28);
            const resizedImageData = tempCtx.getImageData(0, 0, 28, 28);
            
            const tensor = tf.tidy(() => {
                let tensor = tf.browser.fromPixels(resizedImageData, 1);
                tensor = tensor.cast('float32');
                tensor = tensor.div(255.0);
                tensor = tf.scalar(1.0).sub(tensor);
                tensor = tensor.expandDims(0);
                return tensor;
            });
            
            return tensor;
        }

        async function predict() {
            if (!model) {
                document.getElementById('result').innerHTML = '<div style="color: red;">Model not loaded yet!</div>';
                return;
            }

            try {
                document.getElementById('result').innerHTML = '<div class="loading">Predicting...</div>';
                
                const tensor = preprocessCanvas();
                const predictions = await model.predict(tensor).data();
                tensor.dispose();
                
                const predictedDigit = predictions.indexOf(Math.max(...predictions));
                const confidence = Math.max(...predictions);
                
                document.getElementById('result').innerHTML = `
                    <div>
                        <div class="prediction">Predicted Digit: ${predictedDigit}</div>
                        <div class="confidence">Confidence: ${(confidence * 100).toFixed(1)}%</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error making prediction:', error);
                document.getElementById('result').innerHTML = '<div style="color: red;">Error making prediction!</div>';
            }
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>